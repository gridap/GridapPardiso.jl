using Libdl

MKL_FOUND = true

function _find_gcclibdir()
  gcc_bin = Sys.which("gcc")
  if  "/usr/bin" == gcc_bin[1:8]
    return _find_gcclibdir_in_system()
  else
    return _find_gcclibdir_custom()
  end
end

function _find_gcclibdir_in_system()
  for v in [5,6,7,8,9]
    gcclibdir = "/usr/lib/gcc/x86_64-linux-gnu/$v"
    if isdir(gcclibdir)
      l = Libdl.find_library(joinpath(gcclibdir,"libgomp"))
      if l != ""
        return gcclibdir
      end
    end
  end
  MKL_FOUND = false
  s = """
  libgomp could not be found in system. Try
  \$ sudo apt-get install libgomp1
  """
  @warn s
end

function _find_gcclibdir_custom()
  gcc_bin = Sys.which("gcc")
  gcc_root = gcc_bin[1:(end-8)]
  gcclibdir = joinpath(gcc_root,"lib64")
  if ! isdir(gcclibdir)
    error("lib64 directory not found in GCC installation: $gcclibdir")
  end
  gcclibdir
end

deps_jl = "deps.jl"

if isfile(deps_jl)
  rm(deps_jl)
end

mklroot = haskey(ENV,"MKLROOT") ? ENV["MKLROOT"] : ""

if !haskey(ENV,"MKLROOT")
  MKL_FOUND = false
  s = """
  Environment variable MKLROOT not found.

  Please install intel mkl math library and rebuild.
  """
  @warn s
else
  @info "MKLROOT found at: $mklroot"
end

mkllibdir = joinpath(mklroot,"lib/intel64")

if ! isdir(mkllibdir)
  MKL_FOUND = false
  s = """
  MKL lib directory not found: $mkllibdir
  """
  @warn s
else
  @info "MKL libraries found at: $mkllibdir"
end

gcclibdir = haskey(ENV,"GRIDAP_PARDISO_LIBGOMP_DIR") ? ENV["GRIDAP_PARDISO_LIBGOMP_DIR"] : ""
if gcclibdir == ""
  gcclibdir = _find_gcclibdir()
  if ! isdir(gcclibdir)
    MKL_FOUND = false
    s = """
    GCC lib directory not found: $gcclibdir
    """
    @warn s
  else
    @info "GCC libraries found at: $gcclibdir"
  end
else
  @info "Skipping search of GCC libraries, using the value of GRIDAP_PARDISO_LIBGOMP_DIR instead"
end

open(deps_jl,"w") do f
  println(f, "# This file is automatically generated")
  println(f, "# Do not edit")
  println(f)
  println(f, :(const MKL_FOUND = $MKL_FOUND))
  println(f, :(const mklroot   = $mklroot))
  println(f, :(const mkllibdir = $mkllibdir))
  println(f, :(const gcclibdir = $gcclibdir))
end
